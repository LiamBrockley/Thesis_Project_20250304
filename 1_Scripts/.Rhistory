# exprs(gset) <- normalizeBetweenArrays(exprs(gset))
# boxplot(exprs(gset))
# 2024/11/12: I elected to do quantile normalization because this gave me a larger list of "persistent" genes. Could justify that it "better captures the variation between groups" etc
min(exprs(gset))
max(exprs(gset))
## Plot PCA ##
colz <- as.numeric(as.factor(gs)) # Get color values from group
plotMDS(exprs(gset),
gene.selection = "common",
main = "PCA for GSE7895",
col = colz,
pch = 1
#labels = gs
)
legend("topright", legend = levels(as.factor(gs)),
fill = unique(colz),
title = "Smoking status")
# No separation, all mixed up. This isn't a good look.
library(stringr)
phenotypic_data <- pData(gset)  # Extract phenotypic data
# List of column names I want to keep and clean up into usable labels
columns_to_find <- c("characteristics_ch1.1", "group")
# Get the column indexes
indexes <- sapply(columns_to_find, function(col_name) which(names(phenotypic_data) == col_name))
indexes <- unlist(indexes)
phenotypic_data <- phenotypic_data[,c(indexes)]
# Extract Age
phenotypic_data$age <- as.numeric(str_extract(phenotypic_data$characteristics_ch1.1, "(?<=Age:)\\d+"))
# Extract Packyears
phenotypic_data$packyears <- as.numeric(str_extract(phenotypic_data$characteristics_ch1.1, "(?<=Packyears:)\\d+"))
# Extract Time Since Quit Smoking (months)
phenotypic_data$TSQ_months <- as.numeric(str_extract(phenotypic_data$characteristics_ch1.1, "(?<=Time Since Quit Smoking \\(months\\):)\\d+"))
# Delete the original column with the unseparated info
phenotypic_data <- phenotypic_data[,-1]
# Convert the NA values for packyears for never smokers to zero (this makes sense since the never smokers have 0 pack years)
phenotypic_data$packyears[phenotypic_data$group=="never_smoker"] <- 0
# Convert the NA values for TSQ_months to zero for current smokers (again makes sense)
phenotypic_data$TSQ_months[phenotypic_data$group=="current_smoker"] <- 0
# Make column to denote just former smoking status for the linear model
phenotypic_data$former_smoking_status <- as.factor(as.numeric(phenotypic_data$group == "former_smoker"))
# Make column to denote just current smoking status for the linear model
phenotypic_data$current_smoking_status <- as.factor(as.numeric(phenotypic_data$group == "current_smoker"))
# Make column to denote just never smoking status for the linear model
phenotypic_data$never_smoking_status <- as.factor(as.numeric(phenotypic_data$group == "never_smoker"))
## Plot PCA using age to define color
# Create a gradient color palette (light blue to dark blue)
palette <- colorRampPalette(c("lightblue", "darkblue"))
## Plot PCA of age ##
colz_age <- palette(length(phenotypic_data$age))[rank(phenotypic_data$age)]  # Map ages to gradient colors
plotMDS(exprs(gset),
gene.selection = "common",
main = "PCA for GSE7895 (darker blue ~ higher age)",
col = colz_age,
pch = 1
)
# Add a color bar for age
legend("topright", legend = range(phenotypic_data$age),
fill = palette(2),
title = "Age")
# Does not seem to be an age effect
### Plot PCA of packyears ###
# Excluding packyears of zero (never smokers)
pheno_packyears <- phenotypic_data[phenotypic_data$packyears!=0,]
exprs_packyears <- as.data.frame(exprs(gset)) %>%
dplyr::select(rownames(pheno_packyears))
colz_packyears <-  palette(length(pheno_packyears$packyears))[rank(pheno_packyears$packyears)] # Map packyears to gradient colors
plotMDS(exprs_packyears,
gene.selection = "common",
main = "PCA for GSE7895 (darker blue ~ higher packyears)",
col = colz_packyears,
pch = 1
#labels = gs
)
# Add a color bar for packyears
legend("topright", legend = range(pheno_packyears$packyears),
fill = palette(2),
title = "Packyears")
## Does not seem to be packyears effect
### Plot PCA of time since quitting ###
pheno_tsq <- phenotypic_data[!is.na(phenotypic_data$TSQ_months),]
exprs_tsq <- as.data.frame(exprs(gset)) %>%
dplyr::select(rownames(pheno_tsq))
colz_TSQ <- palette(length(pheno_tsq$TSQ))[rank(pheno_tsq$TSQ)]  # Map packyears to gradient colors
plotMDS(exprs_tsq,
gene.selection = "common",
main = "PCA for GSE7895 (darker blue ~ more time since quitting)",
col = colz_TSQ,
pch = 1
#labels = gs
)
legend("topright", legend = range(pheno_tsq$TSQ),
fill = palette(2),
title = "TSQ")
## Does not seem to be TSQ effect
v <- vooma(gset, design, plot=T)
v$genes <- fData(gset) # attach gene annotations
# fit linear model
fit  <- lmFit(v)
# set up contrasts of interest and recalculate model coefficients
#cts <- c(paste(groups[1],"-",groups[2],sep=""), paste(groups[1],"-",groups[3],sep=""), paste(groups[2],"-",groups[3],sep=""))
#cont.matrix <- makeContrasts(contrasts=cts, levels=design)
cont.matrix <- makeContrasts(
CS_vs_NS = current_smoker - never_smoker,
FS_vs_NS = former_smoker - never_smoker,
CS_vs_FS = current_smoker - former_smoker,
levels = design
)
fit2 <- contrasts.fit(fit, cont.matrix)
# compute statistics and table of top significant genes
fit2 <- eBayes(fit2, proportion = 0.01) # Proportion is "assumed proportion of genes which are differentially expressed"
library(dplyr)
library(VennDiagram)
## Separate out genes that are DEGS in CS vs NS and FS vs NS
## Note: I have decided not to filter out genes that are significantly different between CS and FS because I realized that doesn't make logical sense.
# summarize test results as "up", "down" or "not expressed"
dT <- decideTests(fit2, adjust.method="fdr",
p.value=0.05,
lfc=0)
# Note that this already has a p-value cutoff of 0.05 unlike my other datasets, but this is ok because this is the least stringent possible cutoff we will use anyway
# Venn diagram of results
vennDiagram(dT)
# Select the genes differentially expressed in both CS_vs_NS and FS_vs_NS
dT_persistent <- dT %>%
as.data.frame(.) %>%
filter(CS_vs_NS != 0) %>% # Differentially expressed in CS vs NS
filter(CS_vs_NS == FS_vs_NS)# Differentially expressed, same sign in FS vs NS
nrow(dT_persistent) # 128 genes indeed
# Get the toptable format for all genes
tT <- topTable(fit2, adjust="fdr", sort.by="B", number=Inf) # Inf shows all the significant genes
# Filter to the "persistent" genes
tT_persistent <- tT %>%
filter(ID %in% rownames(dT_persistent))
# Filter out blanks, keep lower FDR of ties
tT_persistent <- tT_persistent %>%
filter(Gene.symbol != "") %>% # Remove blank gene symbols
group_by(Gene.symbol) %>%
slice_min(adj.P.Val, with_ties = TRUE) %>%
# For probesets mapping to same gene, keep one with lowest FDR. Keep ties for now to check later.
ungroup()
nrow(tT_persistent)
# Checking for ties
ties <- tT_persistent%>%
group_by(Gene.symbol) %>%
filter(n() > 1) %>%
ungroup()
print(ties)
# As there is a tie with MUCA5 I will remove the MUCA5 probe with an "x" label for cross-reactivity
tT_persistent <- tT_persistent %>% filter (ID != "214303_x_at")
#Pick the columns we care about
GSE7895_persistent_DEGs <- tT_persistent %>%
dplyr::select(., Gene.symbol, CS_vs_NS, FS_vs_NS, CS_vs_FS, adj.P.Val) %>%
dplyr::rename(., Gene = Gene.symbol, CS_NS_A2 = CS_vs_NS, FS_NS_A2 = FS_vs_NS, CS_FS_A2 = CS_vs_FS, FDR_A2 = adj.P.Val)
# Save output
#write.table(GSE7895_persistent_DEGs, "../2_Outputs/1_Airway_DEGs/GSE7895_persistent_DEGs_no_quantile_20241216.txt")
## Filter exprs to the "persistent" genes
exprs_persistent <- as.data.frame(exprs(gset)) %>%
filter(rownames(.) %in% tT_persistent$ID)
## Plot PCA ##
colz<- as.numeric(as.factor(gs)) # Get color values from group
plotMDS(exprs_persistent,
gene.selection = "common",
main = "PCA for GSE7895 with persistent genes",
col = colz,
pch = 1
#labels = gs
)
legend("topright", legend = levels(as.factor(gs)),
fill = unique(colz),
title = "Smoking status")
# You can see more separation happening, but I would expect to see current and former smokers more mixed together, whereas we see former and never smokers more mixed together. Hmm okay, interesting at least.
# Might be good to check on the age, packyears and TSQ here as well?
## Plot PCA of age ##
colz_age <- palette(length(phenotypic_data$age))[rank(phenotypic_data$age)]  # Map ages to gradient colors
plotMDS(exprs_persistent,
gene.selection = "common",
main = "PCA for GSE7895 (darker blue ~ higher age)",
col = colz_age,
pch = 16
)
# Add a color bar for age
legend("topright", legend = range(phenotypic_data$age),
fill = palette(2),
title = "Age")
# Does not seem to be an age effect
### Plot PCA of packyears ###
# Excluding packyears of zero (never smokers)
exprs_persistent_packyears <- as.data.frame(exprs_persistent) %>%
dplyr::select(rownames(pheno_packyears))
colz_packyears <-  palette(length(pheno_packyears$packyears))[rank(pheno_packyears$packyears)] # Map packyears to gradient colors
plotMDS(exprs_persistent_packyears,
gene.selection = "common",
main = "PCA for GSE7895 persistent genes (darker blue ~ higher packyears)",
col = colz_packyears,
pch = 16
#labels = gs
)
# Add a color bar for packyears
legend("bottomleft", legend = range(pheno_packyears$packyears),
fill = palette(2),
title = "Packyears")
## Maybe some sort of packyears effect happening, not obviously so
### Plot PCA of time since quitting ###
exprs_persistent_tsq <- as.data.frame(exprs_persistent) %>%
dplyr::select(rownames(pheno_tsq))
colz_TSQ <- palette(length(pheno_tsq$TSQ))[rank(pheno_tsq$TSQ)]  # Map packyears to gradient colors
plotMDS(exprs_persistent_tsq ,
gene.selection = "common",
main = "PCA for GSE7895 persistent genes (darker blue ~ more months since quitting)",
col = colz_TSQ,
pch = 16
#labels = gs
)
legend("bottomleft", legend = range(pheno_tsq$TSQ),
fill = palette(2),
title = "TSQ")
## Maybe some TSQ effect but not super obvious
A2_test <-  read.table("/Users/liambrockley/Desktop/Former_Smokers_Project/2_Outputs/1_Airway_DEGs/GSE7895_persistent_DEGs_quantile_20250307.txt")
View(A2_test)
A2_test_03 <- read.table("/Users/liambrockley/Desktop/Former_Smokers_Project/2_Outputs/1_Airway_DEGs/GSE7895_persistent_DEGs_quantile_20250307.txt")
View(A2_test_03 )
library(eulerr)
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"" = 116         # overlap
))
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"&" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "Dummy Euler Diagram (CS vs NS and FS vs NS)")
library(eulerr)
fit <- euler(c(
"CS" = 618,           # CS-only
"FS" = 82,            # FS-only
"CS&FS" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "Dummy Euler Diagram (CS vs NS and FS vs NS)")
# load series and platform data from GEO
gset <- getGEO("GSE7895", GSEMatrix =TRUE, AnnotGPL=TRUE)
if (length(gset) > 1) idx <- grep("GPL96", attr(gset, "names")) else idx <- 1
gset <- gset[[idx]]
# make proper column names to match toptable
fvarLabels(gset) <- make.names(fvarLabels(gset))
# group membership for all samples
gsms <- paste0("22222222222222222222200000000000000000000000000000",
"00000000000000000000000111111111111111111111111111",
"1111")
sml <- strsplit(gsms, split="")[[1]]
gset <- gset[complete.cases(exprs(gset)), ] # skip missing values
# assign samples to groups and set up design matrix
gs <- factor(sml)
groups <- make.names(c("current_smoker","former_smoker","never_smoker"))
levels(gs) <- groups
gset$group <- gs
design <- model.matrix(~group + 0, gset)
colnames(design) <- levels(gs)
gset <- gset[complete.cases(exprs(gset)), ] # skip missing values
## Make histograms and boxplots to check if the data is log-transformed and needs quantile normalization ##
hist(as.matrix(exprs(gset))) # Values range 1-15, and 1 big peak around 3.
boxplot(exprs(gset)) # Same range of values, with similar-looking ranges, but not exactly the same
# Narrow range, therefore no log2 normalization needed
## Going to try this again without the quantile to see what happens
# exprs(gset) <- normalizeBetweenArrays(exprs(gset))
# boxplot(exprs(gset))
# 2024/11/12: I elected to do quantile normalization because this gave me a larger list of "persistent" genes. Could justify that it "better captures the variation between groups" etc
min(exprs(gset))
max(exprs(gset))
## Plot PCA ##
colz <- as.numeric(as.factor(gs)) # Get color values from group
plotMDS(exprs(gset),
gene.selection = "common",
main = "PCA for GSE7895",
col = colz,
pch = 1
#labels = gs
)
legend("topright", legend = levels(as.factor(gs)),
fill = unique(colz),
title = "Smoking status")
# No separation, all mixed up. This isn't a good look.
## Make histograms and boxplots to check if the data is log-transformed and needs quantile normalization ##
hist(as.matrix(exprs(gset))) # Values range 1-15, and 1 big peak around 3.
boxplot(exprs(gset)) # Same range of values, with similar-looking ranges, but not exactly the same
# Narrow range, therefore no log2 normalization needed
## Going to try this again without the quantile to see what happens
exprs(gset) <- normalizeBetweenArrays(exprs(gset))
# boxplot(exprs(gset))
# 2024/11/12: I elected to do quantile normalization because this gave me a larger list of "persistent" genes. Could justify that it "better captures the variation between groups" etc
min(exprs(gset))
max(exprs(gset))
## Plot PCA ##
colz <- as.numeric(as.factor(gs)) # Get color values from group
plotMDS(exprs(gset),
gene.selection = "common",
main = "PCA for GSE7895",
col = colz,
pch = 1
#labels = gs
)
legend("topright", legend = levels(as.factor(gs)),
fill = unique(colz),
title = "Smoking status")
# No separation, all mixed up. This isn't a good look.
v <- vooma(gset, design, plot=T)
v$genes <- fData(gset) # attach gene annotations
# fit linear model
fit  <- lmFit(v)
# set up contrasts of interest and recalculate model coefficients
#cts <- c(paste(groups[1],"-",groups[2],sep=""), paste(groups[1],"-",groups[3],sep=""), paste(groups[2],"-",groups[3],sep=""))
#cont.matrix <- makeContrasts(contrasts=cts, levels=design)
cont.matrix <- makeContrasts(
CS_vs_NS = current_smoker - never_smoker,
FS_vs_NS = former_smoker - never_smoker,
CS_vs_FS = current_smoker - former_smoker,
levels = design
)
fit2 <- contrasts.fit(fit, cont.matrix)
# compute statistics and table of top significant genes
fit2 <- eBayes(fit2, proportion = 0.01) # Proportion is "assumed proportion of genes which are differentially expressed"
library(dplyr)
library(VennDiagram)
## Separate out genes that are DEGS in CS vs NS and FS vs NS
## Note: I have decided not to filter out genes that are significantly different between CS and FS because I realized that doesn't make logical sense.
# summarize test results as "up", "down" or "not expressed"
dT <- decideTests(fit2, adjust.method="fdr",
p.value=0.05,
lfc=0)
# Note that this already has a p-value cutoff of 0.05 unlike my other datasets, but this is ok because this is the least stringent possible cutoff we will use anyway
# Venn diagram of results
vennDiagram(dT)
# Select the genes differentially expressed in both CS_vs_NS and FS_vs_NS
dT_persistent <- dT %>%
as.data.frame(.) %>%
filter(CS_vs_NS != 0) %>% # Differentially expressed in CS vs NS
filter(CS_vs_NS == FS_vs_NS)# Differentially expressed, same sign in FS vs NS
nrow(dT_persistent) # 128 genes indeed
# Get the toptable format for all genes
tT <- topTable(fit2, adjust="fdr", sort.by="B", number=Inf) # Inf shows all the significant genes
# Filter to the "persistent" genes
tT_persistent <- tT %>%
filter(ID %in% rownames(dT_persistent))
# Filter out blanks, keep lower FDR of ties
tT_persistent <- tT_persistent %>%
filter(Gene.symbol != "") %>% # Remove blank gene symbols
group_by(Gene.symbol) %>%
slice_min(adj.P.Val, with_ties = TRUE) %>%
# For probesets mapping to same gene, keep one with lowest FDR. Keep ties for now to check later.
ungroup()
nrow(tT_persistent)
# Checking for ties
ties <- tT_persistent%>%
group_by(Gene.symbol) %>%
filter(n() > 1) %>%
ungroup()
print(ties)
# As there is a tie with MUCA5 I will remove the MUCA5 probe with an "x" label for cross-reactivity
tT_persistent <- tT_persistent %>% filter (ID != "214303_x_at")
#Pick the columns we care about
GSE7895_persistent_DEGs <- tT_persistent %>%
dplyr::select(., Gene.symbol, CS_vs_NS, FS_vs_NS, CS_vs_FS, adj.P.Val) %>%
dplyr::rename(., Gene = Gene.symbol, CS_NS_A2 = CS_vs_NS, FS_NS_A2 = FS_vs_NS, CS_FS_A2 = CS_vs_FS, FDR_A2 = adj.P.Val)
# Save output
#write.table(GSE7895_persistent_DEGs, "../2_Outputs/1_Airway_DEGs/GSE7895_persistent_DEGs_no_quantile_20241216.txt")
View(tT_persistent)
??vennDiagram
library(VennDiagram)
View(dT)
?eulerr::euler
library(eulerr)
fit <- euler(c(dT$CS_vs_NS, dT$FS_vs_NS))
class(dT)
dT_df <- as.data.frame(dT)
dT_df <- as.data.frame(dT)
fit <- euler(c(dT_df$CS_vs_NS, dT_df$FS_vs_NS))
dT_df[dT_df == -1,] <- 1
dT_df[dT_df == -1] <- 1
fit <- euler(c(dT_df$CS_vs_NS, dT_df$FS_vs_NS))
fit <- euler(c("CS vs NS" = dT_df$CS_vs_NS, "CS vs FS" = dT_df$FS_vs_NS))
?/VennDiagram::venn.diagram
??VennDiagram::venn.diagram
vennDiagram(dT)
traceback()
class(dT)
limma::vennDiagram()
??limma::vennDiagram()
vennDiagram(dT[1,2])
vennDiagram(dT[c(1,2)])
vennDiagram(dT[c(1,2),])
vennDiagram(dT[,c(1,2)])
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"'CS vs NS'&'FS vs NS'" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "Dummy Euler Diagram (CS vs NS and FS vs NS)")
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"CS vs NS&FS vs NS" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "Dummy Euler Diagram (CS vs NS and FS vs NS)")
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"CS vs NS&FS vs NS" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "A2 Euler Diagram (CS vs NS and FS vs NS)")
## Filter exprs to the "persistent" genes
exprs_persistent <- as.data.frame(exprs(gset)) %>%
filter(rownames(.) %in% tT_persistent$ID)
## Plot PCA ##
colz<- as.numeric(as.factor(gs)) # Get color values from group
plotMDS(exprs_persistent,
gene.selection = "common",
main = "PCA for GSE7895 with persistent genes",
col = colz,
pch = 1
#labels = gs
)
legend("topright", legend = levels(as.factor(gs)),
fill = unique(colz),
title = "Smoking status")
# You can see more separation happening, but I would expect to see current and former smokers more mixed together, whereas we see former and never smokers more mixed together. Hmm okay, interesting at least.
# Might be good to check on the age, packyears and TSQ here as well?
## Plot PCA of age ##
colz_age <- palette(length(phenotypic_data$age))[rank(phenotypic_data$age)]  # Map ages to gradient colors
plotMDS(exprs_persistent,
gene.selection = "common",
main = "PCA for GSE7895 (darker blue ~ higher age)",
col = colz_age,
pch = 16
)
# Add a color bar for age
legend("topright", legend = range(phenotypic_data$age),
fill = palette(2),
title = "Age")
# Does not seem to be an age effect
### Plot PCA of packyears ###
# Excluding packyears of zero (never smokers)
exprs_persistent_packyears <- as.data.frame(exprs_persistent) %>%
dplyr::select(rownames(pheno_packyears))
colz_packyears <-  palette(length(pheno_packyears$packyears))[rank(pheno_packyears$packyears)] # Map packyears to gradient colors
plotMDS(exprs_persistent_packyears,
gene.selection = "common",
main = "PCA for GSE7895 persistent genes (darker blue ~ higher packyears)",
col = colz_packyears,
pch = 16
#labels = gs
)
# Add a color bar for packyears
legend("bottomleft", legend = range(pheno_packyears$packyears),
fill = palette(2),
title = "Packyears")
## Maybe some sort of packyears effect happening, not obviously so
### Plot PCA of time since quitting ###
exprs_persistent_tsq <- as.data.frame(exprs_persistent) %>%
dplyr::select(rownames(pheno_tsq))
colz_TSQ <- palette(length(pheno_tsq$TSQ))[rank(pheno_tsq$TSQ)]  # Map packyears to gradient colors
plotMDS(exprs_persistent_tsq ,
gene.selection = "common",
main = "PCA for GSE7895 persistent genes (darker blue ~ more months since quitting)",
col = colz_TSQ,
pch = 16
#labels = gs
)
legend("bottomleft", legend = range(pheno_tsq$TSQ),
fill = palette(2),
title = "TSQ")
## Maybe some TSQ effect but not super obvious
library(eulerr)
fit <- euler(c(
"CS vs NS" = 618,           # CS-only
"FS vs NS" = 82,            # FS-only
"CS vs NS&FS vs NS" = 116         # overlap
))
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
main = "A2 Euler Diagram (CS vs NS and FS vs NS)")
??plot
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
labels = list(col = "black"),
main = "A2 Euler Diagram (CS vs NS and FS vs NS)")
plot(fit,
fills = c("skyblue", "salmon"),
quantities = TRUE,
# labels = list(col = "black"),
main = "A2 Euler Diagram (CS vs NS and FS vs NS)")
